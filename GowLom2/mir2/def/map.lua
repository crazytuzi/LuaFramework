local linkPoints = import(".maplinks")
local map = {
	opened = {},
	mmapReplace = {},
	path = {
		["0-3"] = {
			2,
			3
		},
		["0-4"] = {
			1,
			4
		},
		["0-11"] = {
			1,
			11
		},
		["1-2"] = {
			0,
			2
		},
		["1-3"] = {
			0,
			2,
			3
		},
		["2-1"] = {
			0,
			1
		},
		["2-4"] = {
			0,
			1,
			4
		},
		["2-11"] = {
			0,
			1,
			11
		},
		["3-0"] = {
			2,
			0
		},
		["3-1"] = {
			2,
			0,
			1
		},
		["3-4"] = {
			2,
			0,
			1,
			4
		},
		["3-11"] = {
			2,
			0,
			1,
			11
		},
		["4-0"] = {
			1,
			0
		},
		["4-2"] = {
			1,
			0,
			2
		},
		["4-3"] = {
			1,
			0,
			2,
			3
		},
		["4-11"] = {
			1,
			11
		},
		["11-0"] = {
			1,
			0
		},
		["11-2"] = {
			1,
			0,
			2
		},
		["11-3"] = {
			1,
			0,
			2,
			3
		},
		["11-4"] = {
			1,
			4
		}
	},
	transferPoints = {
		["0-1"] = {
			{
				x = 324,
				y = 34
			},
			{
				x = 325,
				y = 34
			},
			{
				x = 325,
				y = 35
			},
			{
				x = 326,
				y = 35
			},
			{
				x = 326,
				y = 36
			},
			{
				x = 327,
				y = 36
			},
			{
				x = 327,
				y = 37
			},
			{
				x = 328,
				y = 37
			},
			{
				x = 328,
				y = 38
			},
			{
				x = 325,
				y = 33
			},
			{
				x = 326,
				y = 33
			},
			{
				x = 326,
				y = 34
			},
			{
				x = 327,
				y = 34
			},
			{
				x = 327,
				y = 35
			},
			{
				x = 328,
				y = 35
			},
			{
				x = 328,
				y = 36
			},
			{
				x = 329,
				y = 36
			},
			{
				x = 329,
				y = 37
			}
		},
		["1-0"] = {
			{
				x = 559,
				y = 554
			},
			{
				x = 559,
				y = 555
			},
			{
				x = 560,
				y = 555
			},
			{
				x = 560,
				y = 556
			},
			{
				x = 561,
				y = 556
			},
			{
				x = 561,
				y = 557
			},
			{
				x = 562,
				y = 557
			},
			{
				x = 562,
				y = 558
			},
			{
				x = 563,
				y = 558
			},
			{
				x = 558,
				y = 555
			},
			{
				x = 558,
				y = 556
			},
			{
				x = 559,
				y = 556
			},
			{
				x = 559,
				y = 557
			},
			{
				x = 560,
				y = 557
			},
			{
				x = 560,
				y = 558
			},
			{
				x = 561,
				y = 558
			},
			{
				x = 561,
				y = 559
			},
			{
				x = 562,
				y = 559
			}
		},
		["0-2"] = {
			{
				x = 671,
				y = 82
			},
			{
				x = 672,
				y = 82
			},
			{
				x = 672,
				y = 83
			},
			{
				x = 673,
				y = 83
			},
			{
				x = 673,
				y = 84
			},
			{
				x = 674,
				y = 84
			},
			{
				x = 674,
				y = 85
			},
			{
				x = 675,
				y = 85
			},
			{
				x = 675,
				y = 86
			},
			{
				x = 672,
				y = 81
			},
			{
				x = 673,
				y = 81
			},
			{
				x = 673,
				y = 82
			},
			{
				x = 674,
				y = 82
			},
			{
				x = 674,
				y = 83
			},
			{
				x = 675,
				y = 83
			},
			{
				x = 675,
				y = 84
			},
			{
				x = 676,
				y = 84
			},
			{
				x = 676,
				y = 85
			}
		},
		["2-0"] = {
			{
				x = 413,
				y = 564
			},
			{
				x = 413,
				y = 565
			},
			{
				x = 414,
				y = 546
			},
			{
				x = 415,
				y = 566
			},
			{
				x = 415,
				y = 567
			},
			{
				x = 416,
				y = 567
			},
			{
				x = 416,
				y = 568
			},
			{
				x = 417,
				y = 568
			},
			{
				x = 412,
				y = 565
			},
			{
				x = 412,
				y = 566
			},
			{
				x = 414,
				y = 567
			},
			{
				x = 414,
				y = 568
			},
			{
				x = 415,
				y = 568
			},
			{
				x = 415,
				y = 569
			},
			{
				x = 416,
				y = 569
			}
		},
		["2-3"] = {
			{
				x = 557,
				y = 74
			},
			{
				x = 558,
				y = 74
			},
			{
				x = 558,
				y = 75
			},
			{
				x = 559,
				y = 75
			},
			{
				x = 559,
				y = 76
			},
			{
				x = 560,
				y = 76
			},
			{
				x = 560,
				y = 77
			},
			{
				x = 561,
				y = 77
			},
			{
				x = 561,
				y = 78
			},
			{
				x = 558,
				y = 73
			},
			{
				x = 559,
				y = 73
			},
			{
				x = 559,
				y = 74
			},
			{
				x = 550,
				y = 74
			},
			{
				x = 550,
				y = 75
			},
			{
				x = 561,
				y = 75
			},
			{
				x = 561,
				y = 76
			},
			{
				x = 562,
				y = 76
			},
			{
				x = 562,
				y = 77
			}
		},
		["3-2"] = {
			{
				x = 511,
				y = 775
			},
			{
				x = 511,
				y = 776
			},
			{
				x = 512,
				y = 776
			},
			{
				x = 512,
				y = 777
			},
			{
				x = 513,
				y = 777
			},
			{
				x = 513,
				y = 778
			},
			{
				x = 514,
				y = 778
			},
			{
				x = 514,
				y = 779
			},
			{
				x = 515,
				y = 779
			},
			{
				x = 510,
				y = 776
			},
			{
				x = 510,
				y = 777
			},
			{
				x = 511,
				y = 777
			},
			{
				x = 511,
				y = 778
			},
			{
				x = 512,
				y = 778
			},
			{
				x = 512,
				y = 779
			},
			{
				x = 513,
				y = 779
			},
			{
				x = 513,
				y = 780
			},
			{
				x = 514,
				y = 780
			}
		},
		["4-1"] = {
			{
				x = 445,
				y = 193
			},
			{
				x = 446,
				y = 192
			},
			{
				x = 447,
				y = 191
			},
			{
				x = 448,
				y = 190
			},
			{
				x = 449,
				y = 189
			},
			{
				x = 450,
				y = 188
			}
		},
		["1-4"] = {
			{
				x = 47,
				y = 170
			},
			{
				x = 47,
				y = 169
			},
			{
				x = 48,
				y = 168
			},
			{
				x = 49,
				y = 167
			},
			{
				x = 50,
				y = 166
			},
			{
				x = 51,
				y = 165
			}
		},
		["1-11"] = {
			{
				x = 43,
				y = 34
			},
			{
				x = 44,
				y = 33
			},
			{
				x = 45,
				y = 32
			},
			{
				x = 46,
				y = 31
			},
			{
				x = 47,
				y = 30
			}
		},
		["11-1"] = {
			{
				x = 51,
				y = 478
			},
			{
				x = 50,
				y = 479
			},
			{
				x = 49,
				y = 480
			},
			{
				x = 48,
				y = 481
			},
			{
				x = 47,
				y = 482
			}
		}
	},
	transferPositions = {
		["0-1"] = {
			name = "Œ÷¬Í…≠¡÷",
			x = 566,
			y = 552
		},
		["1-0"] = {
			name = "±»∆Ê °",
			x = 322,
			y = 41
		},
		["0-2"] = {
			name = "∂æ…ﬂ…Ωπ»",
			x = 422,
			y = 558
		},
		["2-0"] = {
			name = "±»∆Ê °",
			x = 667,
			y = 93
		},
		["2-3"] = {
			name = "√À÷ÿ °",
			x = 279,
			y = 743
		},
		["3-2"] = {
			name = "∂æ…ﬂ…Ωπ»",
			x = 290,
			y = 65
		},
		["4-1"] = {
			name = "Œ÷¬Í…≠¡÷",
			x = 54,
			y = 168
		},
		["1-4"] = {
			name = "∑‚ƒßπ»",
			x = 441,
			y = 190
		},
		["1-11"] = {
			name = "∞◊»’√≈",
			x = 47,
			y = 476
		},
		["11-1"] = {
			name = "Œ÷¬Í…≠¡÷",
			x = 49,
			y = 35
		}
	},
	banPoints = {
		["0"] = {
			[3460186] = {
				x = 346,
				y = 186
			},
			[3470186] = {
				x = 347,
				y = 186
			},
			[3480187] = {
				x = 348,
				y = 187
			},
			[3950229] = {
				x = 395,
				y = 229
			},
			[3960229] = {
				x = 396,
				y = 229
			},
			[4000225] = {
				x = 400,
				y = 225
			},
			[3990225] = {
				x = 399,
				y = 225
			},
			[4030221] = {
				x = 403,
				y = 221
			},
			[4040221] = {
				x = 404,
				y = 221
			},
			[3080264] = {
				x = 308,
				y = 264
			},
			[3260288] = {
				x = 326,
				y = 288
			},
			[3230247] = {
				x = 323,
				y = 247
			},
			[3540319] = {
				x = 354,
				y = 319
			},
			[2950250] = {
				x = 295,
				y = 250
			},
			[2960250] = {
				x = 296,
				y = 250
			},
			[2960251] = {
				x = 296,
				y = 251
			},
			[3350299] = {
				x = 335,
				y = 299
			},
			[3350300] = {
				x = 335,
				y = 300
			},
			[3440308] = {
				x = 344,
				y = 308
			},
			[3450308] = {
				x = 345,
				y = 308
			},
			[2950284] = {
				x = 295,
				y = 284
			},
			[2950285] = {
				x = 295,
				y = 285
			},
			[3050275] = {
				x = 305,
				y = 275
			},
			[3050276] = {
				x = 305,
				y = 276
			},
			[3070310] = {
				x = 307,
				y = 310
			},
			[3070311] = {
				x = 307,
				y = 311
			},
			[3170301] = {
				x = 317,
				y = 301
			},
			[3170302] = {
				x = 317,
				y = 302
			},
			[2860295] = {
				x = 286,
				y = 295
			},
			[2890292] = {
				x = 289,
				y = 292
			},
			[2780239] = {
				x = 278,
				y = 239
			},
			[2850236] = {
				x = 285,
				y = 236
			},
			[2710256] = {
				x = 271,
				y = 256
			},
			[2830268] = {
				x = 283,
				y = 268
			},
			[1070316] = {
				x = 107,
				y = 316
			},
			[3140474] = {
				x = 314,
				y = 474
			},
			[4140242] = {
				x = 414,
				y = 242
			},
			[4150241] = {
				x = 415,
				y = 241
			},
			[4160240] = {
				x = 416,
				y = 240
			},
			[6250620] = {
				x = 625,
				y = 620
			},
			[6220639] = {
				x = 622,
				y = 639
			},
			[6290645] = {
				x = 629,
				y = 645
			},
			[6500616] = {
				x = 650,
				y = 616
			},
			[3090613] = {
				x = 309,
				y = 613
			},
			[3100600] = {
				x = 310,
				y = 600
			},
			[2660630] = {
				x = 266,
				y = 630
			},
			[2720621] = {
				x = 272,
				y = 621
			},
			[2950649] = {
				x = 295,
				y = 649
			},
			[2820636] = {
				x = 282,
				y = 636
			},
			[2820635] = {
				x = 282,
				y = 635
			},
			[2830635] = {
				x = 283,
				y = 635
			},
			[2740636] = {
				x = 274,
				y = 636
			},
			[3020622] = {
				x = 302,
				y = 622
			},
			[3110631] = {
				x = 311,
				y = 631
			},
			[3070627] = {
				x = 307,
				y = 627
			},
			[1470033] = {
				x = 147,
				y = 33
			},
			[410108] = {
				x = 41,
				y = 108
			},
			[410109] = {
				x = 41,
				y = 109
			},
			[6640212] = {
				x = 664,
				y = 212
			},
			[6640213] = {
				x = 664,
				y = 213
			},
			[4280474] = {
				x = 428,
				y = 474
			}
		},
		["1"] = {
			[840277] = {
				x = 84,
				y = 277
			},
			[840278] = {
				x = 84,
				y = 278
			},
			[3200056] = {
				x = 320,
				y = 56
			},
			[2150312] = {
				x = 215,
				y = 312
			}
		},
		["2"] = {
			[5230473] = {
				x = 523,
				y = 473
			},
			[5230474] = {
				x = 523,
				y = 474
			},
			[5040498] = {
				x = 504,
				y = 498
			},
			[5160492] = {
				x = 516,
				y = 492
			},
			[5110462] = {
				x = 511,
				y = 462
			},
			[5640169] = {
				x = 564,
				y = 169
			}
		},
		["3"] = {
			[2760320] = {
				x = 276,
				y = 320
			},
			[2550335] = {
				x = 255,
				y = 335
			},
			[2580334] = {
				x = 258,
				y = 334
			},
			[3920329] = {
				x = 392,
				y = 329
			},
			[2900367] = {
				x = 290,
				y = 367
			},
			[3110292] = {
				x = 311,
				y = 292
			},
			[3210302] = {
				x = 321,
				y = 302
			},
			[2900302] = {
				x = 290,
				y = 302
			},
			[3000293] = {
				x = 300,
				y = 293
			},
			[6300274] = {
				x = 630,
				y = 274
			},
			[6310273] = {
				x = 631,
				y = 273
			},
			[6240270] = {
				x = 624,
				y = 270
			},
			[6270278] = {
				x = 627,
				y = 278
			},
			[6240278] = {
				x = 624,
				y = 278
			},
			[6340271] = {
				x = 634,
				y = 271
			},
			[6260320] = {
				x = 626,
				y = 320
			},
			[6340312] = {
				x = 634,
				y = 312
			},
			[6370242] = {
				x = 637,
				y = 242
			},
			[6370333] = {
				x = 637,
				y = 333
			},
			[6450325] = {
				x = 645,
				y = 325
			},
			[6760293] = {
				x = 676,
				y = 293
			},
			[6830285] = {
				x = 683,
				y = 285
			},
			[6760292] = {
				x = 676,
				y = 292
			},
			[6830286] = {
				x = 683,
				y = 286
			},
			[6640282] = {
				x = 664,
				y = 282
			},
			[6720274] = {
				x = 672,
				y = 274
			},
			[6000282] = {
				x = 600,
				y = 282
			},
			[8620174] = {
				x = 862,
				y = 174
			},
			[8630174] = {
				x = 863,
				y = 174
			},
			[3300314] = {
				x = 330,
				y = 314
			},
			[2690351] = {
				x = 269,
				y = 351
			},
			[4100321] = {
				x = 410,
				y = 321
			},
			[4110322] = {
				x = 411,
				y = 322
			},
			[5640287] = {
				x = 564,
				y = 287
			},
			[5640286] = {
				x = 564,
				y = 286
			},
			[6610277] = {
				x = 661,
				y = 277
			},
			[5780296] = {
				x = 578,
				y = 296
			},
			[3060322] = {
				x = 306,
				y = 322
			},
			[1390085] = {
				x = 139,
				y = 85
			},
			[3620325] = {
				x = 362,
				y = 325
			}
		},
		["4"] = {
			[2120192] = {
				x = 212,
				y = 192
			},
			[2130192] = {
				x = 213,
				y = 192
			},
			[2130191] = {
				x = 213,
				y = 191
			},
			[2180197] = {
				x = 218,
				y = 197
			},
			[2190196] = {
				x = 219,
				y = 196
			},
			[2360181] = {
				x = 236,
				y = 181
			},
			[2170238] = {
				x = 217,
				y = 238
			},
			[2210234] = {
				x = 221,
				y = 234
			},
			[2260252] = {
				x = 226,
				y = 252
			},
			[2330250] = {
				x = 233,
				y = 250
			},
			[2330234] = {
				x = 233,
				y = 234
			},
			[2380238] = {
				x = 238,
				y = 238
			},
			[2510199] = {
				x = 251,
				y = 199
			},
			[2580204] = {
				x = 258,
				y = 204
			},
			[1920218] = {
				x = 192,
				y = 218
			},
			[1400067] = {
				x = 140,
				y = 67
			},
			[560066] = {
				x = 56,
				y = 66
			},
			[2050218] = {
				x = 205,
				y = 218
			}
		},
		["11"] = {
			[2040385] = {
				x = 204,
				y = 385
			},
			[3490239] = {
				x = 349,
				y = 239
			},
			[3480240] = {
				x = 348,
				y = 240
			},
			[3470241] = {
				x = 347,
				y = 241
			},
			[3520236] = {
				x = 352,
				y = 236
			},
			[3510237] = {
				x = 351,
				y = 237
			},
			[3500238] = {
				x = 350,
				y = 238
			},
			[1450324] = {
				x = 145,
				y = 324
			},
			[1760362] = {
				x = 176,
				y = 362
			},
			[1780295] = {
				x = 178,
				y = 295
			},
			[2070318] = {
				x = 207,
				y = 318
			},
			[2080272] = {
				x = 208,
				y = 272
			},
			[2250300] = {
				x = 225,
				y = 300
			},
			[2280268] = {
				x = 228,
				y = 268
			}
		}
	},
	noMinimap = {
		d5066 = true,
		d5061 = true,
		d5069 = true,
		d5064 = true,
		d5067 = true,
		d5062 = true,
		d5065 = true,
		d5068 = true,
		d5063 = true
	}
}

function delayLoadFunc()
	print("---------map.txt load end--------")

	local file = res.getfile("config/mmapReplace.txt")
	local datas = string.split(file, "\n")

	for i, v in ipairs(datas) do
		v = string.trim(v)

		if v ~= "" then
			local lists = string.split(v, ",")

			if 1 < #lists then
				local replacedID = string.lower(lists[1])

				for i = 2, #lists, 1 do
					map.mmapReplace[string.lower(lists[i])] = replacedID
				end
			end
		end
	end

	return 
end

scheduler.performWithDelayGlobal(delayLoadFunc, 0)

map.isHasRes = function (mapid)
	return true
end
map.getTransferPoint = function (srcMap, dstMap)
	local key = srcMap .. "-" .. dstMap
	local nextMap, points = nil

	for k, v in pairs(map.path) do
		if k == key then
			nextMap = v[1]

			break
		end
	end

	if nextMap then
		key = srcMap .. "-" .. nextMap
	end

	for k, v in pairs(map.transferPoints) do
		if k == key then
			points = v

			break
		end
	end

	return points
end
map.isBanPoint = function (x, y, mapid)
	if map.banPoints[mapid .. ""] and map.banPoints[mapid .. ""][x*10000 + y] then
		return true
	end

	return false
end
map.getMinimapID = function (mapid)
	mapid = string.lower(mapid)

	if map.noMinimap[mapid] then
		return 
	end

	return map.mmapReplace[mapid] or mapid
end
map.getRoute = function (src, destId, ret)
	local list = {}
	local visitNodes = {}
	local pNode = src
	local links = linkPoints[src.mid]
	visitNodes[tostring(src.mid)] = true

	if not links then
		return false
	end

	local i = 1

	while links do
		if links[i] then
			if visitNodes[links[i].dest] ~= true then
				visitNodes[links[i].dest] = true
				local node = {
					mid = links[i].dest,
					x = links[i].x,
					y = links[i].y,
					index = i,
					parent = pNode
				}

				if node.mid == destId then
					ret[#ret + 1] = node

					return true
				end

				list[#list + 1] = node
			end

			i = i + 1
		else
			local head = list[1]

			if not head then
				print("canot find one path")

				return false
			end

			table.remove(list, 1)

			links = linkPoints[head.mid]
			links = links or {}
		end

		pNode = head
		i = 1
	end

	return false
end
map.orderPoints = function (ret)
	local points = {}
	local last = ret[1]

	while last.parent do
		table.insert(points, 1, {
			x = last.x,
			y = last.y,
			destid = last.mid
		})

		last = last.parent
	end

	return points
end
map.findNearstPath = function (ret)
	local allPoints = {}

	for i = 1, #ret, 1 do
		allPoints[#allPoints + 1] = map.orderPoints({
			ret[i]
		})
	end

	local b = 1
	local last = #allPoints[1]

	for i = 2, #allPoints, 1 do
		local tmp = allPoints[i]

		if #tmp < last then
			b = i
			last = allPoints[i]
		end
	end

	return allPoints[b]
end

return map
